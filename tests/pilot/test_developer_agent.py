import os
import unittest

from core.config.config_loader import ConfigLoader
from core.llms import LLMFactory
from core.pilot.developer import DeveloperAgent
from core.pilot.schema import BreakdownLayoutTranslation

os.chdir("../")
config = ConfigLoader.from_file("./config.yaml")
llm_client = LLMFactory.create_llm_from_config(llm_client_type="openai",
                                               llm_config=config.llm_config["openai"].dict())


class TestDeveloperAgent(unittest.TestCase):

    def test_breakdown_android_layout(self):
        android_layouts = {
            "app/src/main/res/layout/activity_login.xml": {
            "name": "app/src/main/res/layout/activity_login.xml",
            "content": "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<android.support.constraint.ConstraintLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\nxmlns:app=\"http://schemas.android.com/apk/res-auto\"\nxmlns:tools=\"http://schemas.android.com/tools\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"match_parent\"\nandroid:background=\"#d5efebe9\"\nandroid:orientation=\"vertical\"\nandroid:theme=\"@style/MyTheme\"\ntools:context=\"app.infiniverse.grocery.LoginActivity\">\n\n<LinearLayout\nandroid:id=\"@+id/linearLayout3\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"150sp\"\nandroid:background=\"@drawable/background\"\nandroid:gravity=\"center\"\napp:layout_constraintBottom_toBottomOf=\"parent\"\napp:layout_constraintEnd_toEndOf=\"parent\"\napp:layout_constraintStart_toStartOf=\"parent\"\napp:layout_constraintTop_toTopOf=\"parent\"\napp:layout_constraintVertical_bias=\"0.0\">\n\n<TextView\nandroid:id=\"@+id/textView2\"\nandroid:layout_width=\"wrap_content\"\nandroid:layout_height=\"wrap_content\"\nandroid:text=\"Login\"\nandroid:textColor=\"@color/partial_transparent\"\nandroid:textSize=\"30sp\"\nandroid:textStyle=\"bold\" />\n</LinearLayout>\n\n<android.support.v7.widget.CardView\nandroid:id=\"@+id/cardView\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"249dp\"\nandroid:layout_margin=\"20dp\"\nandroid:layout_marginBottom=\"8dp\"\napp:cardBackgroundColor=\"@color/black_trans80\"\napp:layout_constraintBottom_toBottomOf=\"parent\"\napp:layout_constraintBottom_toTopOf=\"@+id/linearLayout4\"\napp:layout_constraintEnd_toEndOf=\"@+id/forget\"\napp:layout_constraintHorizontal_bias=\"0.49\"\napp:layout_constraintStart_toStartOf=\"@+id/forget\"\napp:layout_constraintTop_toBottomOf=\"@+id/linearLayout3\"\napp:layout_constraintVertical_bias=\"0.0\">\n\n<LinearLayout\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"match_parent\"\nandroid:background=\"#fafafa\"\nandroid:orientation=\"vertical\">\n\n\n<android.support.design.widget.TextInputLayout\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_marginEnd=\"40dp\"\nandroid:layout_marginStart=\"40dp\"\nandroid:layout_marginTop=\"28dp\">\n\n<EditText\nandroid:id=\"@+id/loginid\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:drawablePadding=\"5sp\"\nandroid:drawableStart=\"@drawable/ic_email_black\"\nandroid:hint=\" Email\"\nandroid:imeOptions=\"actionUnspecified\"\nandroid:maxLines=\"1\"\nandroid:singleLine=\"true\"\nandroid:textColor=\"@color/blue_grey\" />\n\n</android.support.design.widget.TextInputLayout>\n\n\n<android.support.design.widget.TextInputLayout\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_marginEnd=\"40dp\"\nandroid:layout_marginStart=\"40dp\"\nandroid:layout_marginTop=\"0dp\">\n\n<EditText\nandroid:id=\"@+id/password\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:drawablePadding=\"5sp\"\nandroid:drawableStart=\"@drawable/ic_person_black\"\nandroid:hint=\" Password\"\nandroid:imeOptions=\"actionUnspecified\"\nandroid:inputType=\"textPassword\"\nandroid:maxLines=\"1\"\nandroid:singleLine=\"true\"\nandroid:textColor=\"@color/blue_grey\" />\n</android.support.design.widget.TextInputLayout>\n\n<Button\nandroid:id=\"@+id/login\"\nandroid:layout_width=\"wrap_content\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_gravity=\"end\"\nandroid:layout_margin=\"25sp\"\nandroid:background=\"@drawable/btn_background\"\nandroid:text=\"Sign In\"\nandroid:textColor=\"@color/color_black_light\"\nandroid:textStyle=\"bold\" />\n\n</LinearLayout>\n</android.support.v7.widget.CardView>\n\n<TextView\nandroid:id=\"@+id/forget\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_marginEnd=\"24dp\"\nandroid:layout_marginStart=\"8dp\"\nandroid:text=\"Forget Password? Click Here\"\nandroid:textAlignment=\"textEnd\"\nandroid:textColor=\"@color/blue_grey\"\nandroid:textSize=\"15dp\"\napp:layout_constraintEnd_toEndOf=\"parent\"\napp:layout_constraintHorizontal_bias=\"0.32\"\napp:layout_constraintStart_toStartOf=\"parent\"\napp:layout_constraintTop_toBottomOf=\"@+id/cardView\" />\n\n<LinearLayout\nandroid:id=\"@+id/linearLayout4\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:background=\"@color/black_trans80\"\nandroid:gravity=\"bottom|center\"\nandroid:orientation=\"horizontal\"\nandroid:padding=\"20sp\"\napp:layout_constraintBottom_toBottomOf=\"parent\"\napp:layout_constraintEnd_toEndOf=\"parent\"\napp:layout_constraintStart_toStartOf=\"parent\"\napp:layout_constraintTop_toBottomOf=\"parent\"\napp:layout_constraintVertical_bias=\"1.0\">\n\n\n<TextView\nandroid:layout_width=\"wrap_content\"\nandroid:layout_height=\"match_parent\"\nandroid:gravity=\"bottom\"\nandroid:text=\"Don't have an Account? \"\nandroid:textColor=\"@color/blue_grey\"\nandroid:textSize=\"15sp\" />\n\n<TextView\nandroid:id=\"@+id/signup\"\nandroid:layout_width=\"wrap_content\"\nandroid:layout_height=\"match_parent\"\nandroid:clickable=\"true\"\nandroid:focusable=\"true\"\nandroid:gravity=\"bottom\"\nandroid:text=\"SignUp\"\nandroid:textColor=\"@color/blue_grey\"\nandroid:textSize=\"15sp\"\nandroid:textStyle=\"bold\" />\n</LinearLayout>\n</android.support.constraint.ConstraintLayout>\n",
            "java": "package app.infiniverse.grocery;\n\nimport android.content.Intent;\nimport android.content.SharedPreferences;\nimport android.os.AsyncTask;\nimport android.os.Bundle;\nimport android.support.v7.app.AlertDialog;\nimport android.support.v7.app.AppCompatActivity;\nimport android.view.View;\nimport android.widget.Button;\nimport android.widget.EditText;\nimport android.widget.TextView;\nimport android.widget.Toast;\n\nimport org.json.JSONArray;\nimport org.json.JSONObject;\n\nimport java.io.BufferedReader;\nimport java.io.BufferedWriter;\nimport java.io.InputStream;\nimport java.io.InputStreamReader;\nimport java.io.OutputStream;\nimport java.io.OutputStreamWriter;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.net.URLEncoder;\n\npublic class LoginActivity extends AppCompatActivity {\n\npublic static final String PREFS = \"PREFS\";\nEditText etLogin_id, etPassword;\nButton btnLogin;\nString login_id, password;\nTextView signup, forget;\nSharedPreferences sp;\nSharedPreferences.Editor edit;\n\n@Override\nprotected void onCreate(Bundle savedInstanceState) {\nsuper.onCreate(savedInstanceState);\nsetContentView(R.layout.activity_login);\n\nsp = getApplicationContext().getSharedPreferences(PREFS, MODE_PRIVATE);\nedit = sp.edit();\n\nsignup = findViewById(R.id.signup);\netLogin_id = findViewById(R.id.loginid);\netPassword = findViewById(R.id.password);\nbtnLogin = findViewById(R.id.login);\nforget = findViewById(R.id.forget);\nbtnLogin.setOnClickListener(new View.OnClickListener() {\n@Override\npublic void onClick(View view) {\nlogin();\n}\n});\nsignup.setOnClickListener(new View.OnClickListener() {\n@Override\npublic void onClick(View view) {\n\nIntent intent = new Intent(getApplicationContext(), RegisterActivity.class);\nstartActivity(intent);\nfinish();\n}\n});\nforget.setOnClickListener(new View.OnClickListener() {\n@Override\npublic void onClick(View v) {\n\nIntent intent = new Intent(getApplicationContext(), ForgetActivity.class);\nstartActivity(intent);\nfinish();\n}\n});\n}\n\npublic void login() {\nlogin_id = etLogin_id.getText().toString();\npassword = etPassword.getText().toString();\nif ((!login_id.equals(\"\")) && (!password.equals(\"\"))) {\nclass LoginUser extends AsyncTask<String, Void, String> {\n\n@Override\nprotected void onPreExecute() {\nsuper.onPreExecute();\n}\n\n@Override\nprotected void onPostExecute(String s) {\nsuper.onPostExecute(s);\nif (s.trim().equals(\"INLOGIN\")) {\nAlertDialog.Builder builder = new AlertDialog.Builder(LoginActivity.this);\nbuilder.setTitle(\"Login Status\")\n.setMessage(\"Invalid Login\");\nbuilder.show();\n} else {\n\ntry {\nJSONArray clientDetailArray = new JSONArray(s);\nJSONObject json_data = new JSONObject();\njson_data = clientDetailArray.getJSONObject(0);\n\n\nedit.putString(\"loginid\", json_data.getString(\"email\"));\nedit.putString(\"name\", json_data.getString(\"name\"));\nedit.putString(\"mobile\", json_data.getString(\"mobile\"));\nedit.putString(\"city\", json_data.getString(\"city\"));\nedit.putString(\"locality\", json_data.getString(\"locality\"));\nedit.putString(\"address\", json_data.getString(\"address\"));\nedit.putString(\"c_dt\", json_data.getString(\"c_dt\"));\nedit.apply();\nIntent i = new Intent(LoginActivity.this, StartActivity.class);\nstartActivity(i);\nToast.makeText(LoginActivity.this, \"Login Successful\", Toast.LENGTH_SHORT).show();\nfinish();\n} catch (Exception e) {\nToast.makeText(LoginActivity.this, \"Invalid Login\"\n, Toast.LENGTH_SHORT).show();\n}\n}\n\n}\n\n@Override\nprotected String doInBackground(String... params) {\n\nString urls = getResources().getString(R.string.base_url).concat(\"login_user/\");\ntry {\nURL url = new URL(urls);\nHttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();\nhttpURLConnection.setRequestMethod(\"POST\");\nhttpURLConnection.setDoInput(true);\nhttpURLConnection.setDoOutput(true);\nOutputStream outputStream = httpURLConnection.getOutputStream();\nBufferedWriter bufferedWriter = new BufferedWriter(new OutputStreamWriter(outputStream, \"UTF-8\"));\nString post_Data = URLEncoder.encode(\"login_id\", \"UTF-8\") + \"=\" + URLEncoder.encode(params[0], \"UTF-8\") + \"&\" +\nURLEncoder.encode(\"password\", \"UTF-8\") + \"=\" + URLEncoder.encode(params[1], \"UTF-8\");\n\nbufferedWriter.write(post_Data);\nbufferedWriter.flush();\nbufferedWriter.close();\noutputStream.close();\nInputStream inputStream = httpURLConnection.getInputStream();\nBufferedReader bufferedReader = new BufferedReader(new InputStreamReader(inputStream, \"UTF-8\"));\nString result = \"\", line = \"\";\nwhile ((line = bufferedReader.readLine()) != null) {\nresult += line;\n}\nreturn result;\n} catch (Exception e) {\nreturn e.toString();\n}\n}\n}\n\n//creating asynctask object and executing it\nLoginUser loginUsrObj = new LoginUser();\nloginUsrObj.execute(login_id, password);\n} else {\nToast.makeText(this, \"All Fields Are Mandatory\", Toast.LENGTH_SHORT).show();\n}\n}\n}",
            "contains": []
        }
        }
        android_layout_xml_name = list(android_layouts.keys())[0]
        layout_translation = BreakdownLayoutTranslation(
            tasks=[{
                "description": f"将{android_layout_xml_name}转译为对应的Harmony页面",
                "done": False,
                "android": android_layout_xml_name,
                "harmony": "ets/pages/Index.ets"
            }]
        )
        developer_agent = DeveloperAgent(llm_client=llm_client)
        response = developer_agent.breakdown_android_layout(layout_translation, android_layouts)
        print(response.model_dump_json())
        print(response.model_dump())


